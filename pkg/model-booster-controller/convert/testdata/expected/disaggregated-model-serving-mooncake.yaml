apiVersion: workload.serving.volcano.sh/v1alpha1
kind: ModelServing
metadata:
  labels:
    workload.serving.volcano.sh/backend-name: ds-r1-qwen-7b-pd
    workload.serving.volcano.sh/managed-by: workload.serving.volcano.sh
    workload.serving.volcano.sh/model-name: ds-r1-qwen-7b-pd
    workload.serving.volcano.sh/model-uid: randomUID
    workload.serving.volcano.sh/revision: 59fc79f5f5
  name: ds-r1-qwen-7b-pd-ds-r1-qwen-7b-pd
  namespace: demo
  ownerReferences:
    - apiVersion: workload.serving.volcano.sh/v1alpha1
      kind: ModelBooster
      name: ds-r1-qwen-7b-pd
      uid: randomUID
spec:
  replicas: 1
  schedulerName: "volcano"
  template:
    restartGracePeriodSeconds: 60
    gangPolicy:
      minRoleReplicas:
        prefill: 1
        decode: 1
    roles:
      - entryTemplate:
          metadata:
            labels:
              workload.serving.volcano.sh/backend-name: ds-r1-qwen-7b-pd
              workload.serving.volcano.sh/managed-by: workload.serving.volcano.sh
              workload.serving.volcano.sh/model-name: ds-r1-qwen-7b-pd
              workload.serving.volcano.sh/model-uid: randomUID
              workload.serving.volcano.sh/revision: 59fc79f5f5
          spec:
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllmdisaggregated
                  - --engine-base-url
                  - http://localhost:8000
                  - --engine-metrics-path
                  - /metrics
                  - --pod
                  - $(POD_NAME).$(NAMESPACE)
                  - --model
                  - ds-r1-qwen-7b-pd
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: REDIS_HOST
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_HOST
                        name: redis-config
                        optional: true
                  - name: REDIS_PORT
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_PORT
                        name: redis-config
                        optional: true
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        key: REDIS_PASSWORD
                        name: redis-secret
                        optional: true
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: HCCL_IF_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                image: kthena/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - bash
                  - -c
                  - "pip install mooncake-transfer-engine && python3 -m vllm.entrypoints.openai.api_server \
                    --model /cache/568a486051fd302c338d84946c4f3d48 \
                    --disable-frontend-multiprocessing \
                    --gpu-memory-utilization 0.99 \
                    --kv-transfer-config {\"kv_connector\":\"MooncakeConnector\",\"kv_role\":\"kv_producer\"} \
                    --max-model-len 2048 \
                    --quantization ascend \
                    --served-model-name ds-r1-qwen-7b-pd \
                    --tensor-parallel-size 16 \
                    --trust-remote-code"
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: REDIS_HOST
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_HOST
                        name: redis-config
                        optional: true
                  - name: REDIS_PORT
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_PORT
                        name: redis-config
                        optional: true
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        key: REDIS_PASSWORD
                        name: redis-secret
                        optional: true
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: HCCL_IF_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                image: vllm-prefill:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 180
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  limits:
                    nvidia.com/gpu: "2"
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: kthena/downloader:latest
                name: ds-r1-qwen-7b-pd-model-downloader
                resources: {}
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            volumes:
              - hostPath:
                  path: /cache
                  type: DirectoryOrCreate
                name: ds-r1-qwen-7b-pd-weights
        name: prefill
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
      - entryTemplate:
          metadata:
            labels:
              workload.serving.volcano.sh/backend-name: ds-r1-qwen-7b-pd
              workload.serving.volcano.sh/managed-by: workload.serving.volcano.sh
              workload.serving.volcano.sh/model-name: ds-r1-qwen-7b-pd
              workload.serving.volcano.sh/model-uid: randomUID
              workload.serving.volcano.sh/revision: 59fc79f5f5
          spec:
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllmdisaggregated
                  - --engine-base-url
                  - http://localhost:8000
                  - --engine-metrics-path
                  - /metrics
                  - --pod
                  - $(POD_NAME).$(NAMESPACE)
                  - --model
                  - ds-r1-qwen-7b-pd
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: REDIS_HOST
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_HOST
                        name: redis-config
                        optional: true
                  - name: REDIS_PORT
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_PORT
                        name: redis-config
                        optional: true
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        key: REDIS_PASSWORD
                        name: redis-secret
                        optional: true
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: GLOO_SOCKET_IFNAME
                    value: eth0
                  - name: TP_SOCKET_IFNAME
                    value: eth0
                  - name: HCCL_SOCKET_IFNAME
                    value: eth0
                envFrom:
                - secretRef:
                    name: downloader-secrets
                image: kthena/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - bash
                  - -c
                  - "pip install mooncake-transfer-engine && python3 -m vllm.entrypoints.openai.api_server \
                    --model /cache/568a486051fd302c338d84946c4f3d48 \
                    --disable-frontend-multiprocessing \
                    --gpu-memory-utilization 0.95 \
                    --kv-transfer-config {\"kv_connector\":\"MooncakeConnector\",\"kv_role\":\"kv_consumer\"} \
                    --max-model-len 1024 \
                    --quantization ascend \
                    --served-model-name ds-r1-qwen-7b-pd \
                    --tensor-parallel-size 16 \
                    --trust-remote-code"
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: REDIS_HOST
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_HOST
                        name: redis-config
                        optional: true
                  - name: REDIS_PORT
                    valueFrom:
                      configMapKeyRef:
                        key: REDIS_PORT
                        name: redis-config
                        optional: true
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        key: REDIS_PASSWORD
                        name: redis-secret
                        optional: true
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: GLOO_SOCKET_IFNAME
                    value: eth0
                  - name: TP_SOCKET_IFNAME
                    value: eth0
                  - name: HCCL_SOCKET_IFNAME
                    value: eth0
                image: vllm-decode:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 180
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  limits:
                    nvidia.com/gpu: "2"
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: kthena/downloader:latest
                name: ds-r1-qwen-7b-pd-model-downloader
                resources: { }
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            volumes:
              - hostPath:
                  path: /cache
                  type: DirectoryOrCreate
                name: ds-r1-qwen-7b-pd-weights
        name: decode
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
status:
  availableReplicas: 0
