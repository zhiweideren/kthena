# Description: Template for Qwen3-Coder-30B-A3B-Instruct model deployment with vLLM backend
apiVersion: workload.serving.volcano.sh/v1alpha1
kind: ModelBooster
metadata:
  annotations:
    api.kubernetes.io/name: {{ .Values.annotationName | default "example" | quote }}
  name: {{ .Values.name | default "qwen3-coder-30b" | quote }}
  {{- if .Values.namespace }}
  namespace: {{ .Values.namespace | quote }}
  {{- end }}
spec:
  name: {{ .Values.modelName | default .Values.name | default "qwen3-coder-30b" | quote }}
  owner: {{ .Values.owner | default "example" | quote }}
  backend:
    name: {{ .Values.backendName | default "qwen3-coder-30b" | quote }}
    type: {{ .Values.backendType | default "vLLM" | quote }}
    modelURI: {{ .Values.modelURI | default "hf://Qwen/Qwen3-Coder-30B-A3B-Instruct" | quote }}
    cacheURI: {{ .Values.cacheURI | default "hostpath://mnt/cache" | quote }}
    minReplicas: {{ .Values.minReplicas | default 1 }}
    maxReplicas: {{ .Values.maxReplicas | default 1 }}
    workers:
      - type: {{ .Values.workerType | default "server" | quote }}
        image: {{ .Values.workerImage | default "vllm/vllm-openai:latest" | quote }}
        replicas: {{ .Values.workerReplicas | default 1 }}
        pods: {{ .Values.workerPods | default 1 }}
        config:
          served-model-name: {{ .Values.modelName | default .Values.name | default "qwen3-coder-30b" | quote }}
          tensor-parallel-size: {{ .Values.tensorParallelSize | default 4 }}
          enforce-eager: ""  # Enable PyTorch eager mode if GPU compute capability is below 8.0
          gpu-memory-utilization: {{ .Values.gpuMemoryUtilization | default "0.85" }}
          max-model-len: {{ .Values.maxModelLen | default "2048" }}
        resources:
          limits:
            nvidia.com/gpu: {{ .Values.gpuLimit | default "4" | quote }}
